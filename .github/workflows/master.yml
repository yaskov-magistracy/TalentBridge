name: Docker Image CI

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_BACKEND_IMAGE: fnatikjk/talentbridge-backend:last
  DOCKER_BACKEND_LOGIN: fnatikjk
  DOCKER_FRONTEND_IMAGE: iceneo/talentbridge-frontend:last
  DOCKER_FRONTEND_LOGIN: iceneo

jobs:
  build-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Docker login
      env:
        DOCKER_LOGIN: ${{ env.DOCKER_BACKEND_LOGIN }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_BACKEND_PASSWORD }}
      run:
        docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD

    - name: Build and push image
      env:
        IMAGE_TAG: ${{ env.DOCKER_BACKEND_IMAGE }}
      run: |
        cd ./src/PublicAPI
        docker build -f Dockerfile --force-rm -t $IMAGE_TAG .
        docker push $IMAGE_TAG

  # build-frontend:
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #   - name: Checkout
  #     uses: actions/checkout@v3
  #
  #   - name: Docker login
  #     env:
  #       DOCKER_LOGIN: ${{ env.DOCKER_FRONTEND_LOGIN }}
  #       DOCKER_PASSWORD: ${{ secrets.DOCKER_FRONTEND_PASSWORD }}
  #     run:
  #       docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
  #
  #   - name: Build and push image
  #     env:
  #       IMAGE_TAG: ${{ env.DOCKER_FRONTEND_IMAGE }}
  #     run: |
  #       cd ./client
  #       docker build -f Dockerfile --force-rm -t $IMAGE_TAG .
  #       docker push $IMAGE_TAG

  deploy:
    runs-on: ubuntu-latest

    needs: ["build-backend"]

    steps:
    - name: Run docker compose
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ vars.VPS_HOST }}
        username: ${{ vars.SSH_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd deploy
          sudo sh compose.sh
